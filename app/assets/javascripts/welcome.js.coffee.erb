# Place all the behaviors and hooks related to the matching controller here.
# All this logic will automatically be available in application.js.
# You can use CoffeeScript in this file: http://coffeescript.org/

$("#city-code-selector").on "click", "button", ->
	$this = $(this)
	buildAreaButtons($this.val())
	$("#doorplate-search-form input[name=cityCode]").val($this.val())
	$("#city-code-selector button").removeClass("active")
	$this.addClass("active")

$("#area-code-selector").on "click", "button", ->
	$this = $(this)
	$("#doorplate-search-form input[name=areaCode]").val($this.val())
	$("#area-code-selector button.active").removeClass("active")
	$this.addClass("active")

buildAreaButtons = (cityCode) ->
	$("#area-code-selector").empty()
	#$("#area-code-selector").append("<label class=\"btn btn-default\"><input type=\"checkbox\" value=\"\">不拘</label>")
	areaCode = $.map($(document).attr("cityAreaCodes"), (val) ->
	    val.areas if val.cityCode == cityCode
	)
	$(areaCode).each ->
		node = $("<label class=\"btn btn-default\"><input type=\"checkbox\"></label>")
		$("input", node).val($(this)[0].areaCode)
		node.append($(this)[0].areaName)
		$("#area-code-selector").append(node)

buildDoorplates = (doorplates)->
	$("#doorplate-list").empty()
	if $(doorplates).length > 0
		$("#doorplate-list").append($("<table class='table table-striped'><tbody></tbody></table>"))
		$(doorplates).each ->
			content = $(this)[0].address
			content = emphasizeVillage(content)
			content = emphasizeNeighbor(content)
			node = $("<tr><td>#{content}</td></tr>")
			$("#doorplate-list tbody").append(node)
	else
		$("#doorplate-list").append $("<div class='jumbotron'><h3>沒有資料</h3></div>")

emphasizeVillage = (str)->
	emphasize(str, "strong alley", str.substr(str.match(/[區鄉鎮市][^區鄉鎮市]{1,3}[里村]/).index+1).match(/\D{1,3}[里村]/)[0])

emphasizeNeighbor = (str)->
	emphasize(str, "strong neighbor", /\d{3}鄰/)

emphasize = (str, classes, regexp)->
	str.replace(regexp, "<span class='#{classes}'>"+str.match(regexp)[0]+"</span>")

buildAddressData = ->
  sortedAddress = []
  $.twAddrData = JSON.parse localStorage.twAddrData
  
  $.map($.twAddrData.Data, (elm, zip) ->
    $.map(elm, (elm2, city) ->
      sortedAddress[city] = [] unless sortedAddress[city]?
      $.map(elm2, (elm3, area) ->
        $.map(elm3, (street, index) ->
          sortedAddress[city].push(area+street)
        )
      )
    )
  )
  $.twAddrData.sortedAddress = sortedAddress

$.ajax {
	url: '<%= asset_path "cityAreaCodes.json" %>',
	type: "GET",
	dataType: "json"
	success: (data)->
		$(document).attr("cityAreaCodes", data)
		buildAreaButtons(data[0].cityCode)
		$("#city-code-selector button")[0].click()
	,
	error: ->
		alert("Error loading area codes")
}

$.ajax {
  url: '<%= asset_path "zip3.json" %>',
  type: "GET",
  dataType: "json"
  success: (data) ->
    localStorage.twAddrData = JSON.stringify(data)
    buildAddressData()
  error: ->
    alert("Error loading typeahead data for street")
}

$(document).ready ->
	$("#doorplate-search-form").on("ajax:success", (e, data, status, xhr) ->
		buildDoorplates xhr.responseJSON.rows
	).on("ajax:error", (e, xhr, status, error) ->
		$("#doorplate-list").append $("<div class='jumbotron'><h3>查詢失敗</h3></div>")
  ).on("ajax:before", ->
    areas = $("#area-code-selector label.active input").map(->
      $(this).val()
    ).toArray().join(",")
    $("input[name='areaCode']").val(areas)
  )
